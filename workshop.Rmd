---
title: "AMR tutorial"
author: "Sara Burgess"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Day 1 

#### Setting up an R project

It is good practice to set up your analysis as an R project. This enables reproducible code, you can share your zipped project file with others and it can be linked with github. 

Set up an R project.

![](Rproject2.png)

Once your project has been setup you can open it during a new R studio session by selecting:

File > Open Project 

Browse to project directory

Open <project_name>.Rproj file


#### Terminology

***Function*** 

To find out the arguments of a function use ? or help

```{r, eval = FALSE}
?read.csv
help(read.csv)
```

***Argument*** : The expressions that are passed into a function

***Assignment operator*** <- Assigns the values/data frame, vector, list etc... on the right to the object on the left. 

***Object***

***Data frame***

***Vector***

**Pipe Operator*** %>% chains together several operation so that the result of the previous line feeds into the subsequent line. 

***Package***

***Tibble***

**Tidyverse** A collection of easy to use R packages designed for data scientists to carry out data analyses such as tidying, manipulating and plotting data.

See https://bookdown.org/amy_yarnell/T32-book/selected-glossary-of-r-terminology.html for some more defintions. 

### Installing and loading packages

Install the R packages AMR, tidyverse, and readxl

New packages can be installed by selecting:

Tools > Install Packages

Alternatively using the R code below

```{r, eval = FALSE}
install.packages("AMR")
install.packages("tidyverse")
install.packages("readxl")
install.packages("cleaner")
```

Load the packages.

Note: Packages will need to loaded at the beginning of each R session. 

```{r, results='hide', collapse=TRUE, message=FALSE}
library(AMR)
library(tidyverse)
library(readxl)
library(cleaner)
```


## Tidying and checking data

### Reading in data

Read in a csv file using base R

```{r, error= TRUE}
campy <- read.csv("data/Campylobacter_117.csv", header = TRUE)
```
Why do we get this error?


Read in a modified csv file that does not contain these characters.

```{r}
campy <- read.csv("data/Campylobacter_117v2.csv", header = TRUE)
```

Read in the csv file using the readr package from tidyverse. 

```{r}
campy <- read_csv("data/Campylobacter_117v2.csv")
```

The advantages of using read_csv are: you do not need to specify that the first line of data are column names, it is faster and it provides more information on the file you are reading.

Readin an excel sheet using the readxl package.

```{r read}
ecoli <- read_excel("data/Bh_AMR_Surveillance data.xlsx", sheet = "E.coli")
```

### Check your data

Some recommendations for "tidy data" include:

* Keep names simple

* Use an underscore _ instead of a space or preferably one word

* Use abbreviated words instead of a symbol. e.g. perc instead of %

* Be consistent between tables e.g. id versus i.d versus ID

* Each variable results in one column

* Each observation results in one row

The function str() is probably the most important function in R for checking the structure of your data. This gives you information on the number of rows and columns, the names of your columns, the class of each column. 

```{r}
str(ecoli)
```

Use the functions head(), tail(), glimpse(), summary() and table() to check your data.

```{r}
head(ecoli)
tail(ecoli)
glimpse(ecoli)
summary(ecoli)
table(ecoli$'Name of meat shop', useNA = "ifany")
```

How are these functions different?

### Tidying your data

***Group activity***

What types of things could be tidied up in the "ecoli" dataset?

Why is column 5 labelled "...5" and column 19 labelled "SIR...19?

```{r}
colnames(ecoli)
```

***Subsetting***

The first step in tidying your data could be selecting the columns of interest (or you may want to do this further downstream in the analysis). The select() function from the dplyr package is used to select columns of interest or remove columns. The first argument is the dataframe and the subsequent arguments are the columns that are being selected. 

```{r}
#Select by column number
select(ecoli, 16:18)

#Select by column name 
select(ecoli, Stratification, 'Location Name', 'Sample type')
```

Use the select function to remove the SIR columns (which contain no values) and assign it the object "ecoli_select".

```{r}
#Remove columns                    
ecoli_select <- select(ecoli, !starts_with("SIR"))
str(ecoli_select)
```

To only keep rows that match a certain condition the filter() function can be used.

```{r}
filter(ecoli, `Location Name` == "Babesa")
```

Multiple functions can also be chained together using %>%. In the example below the dataframe is piped into the select() function, which is used to select the columns of interest then the result from this is piped into the filter function, which is used to select those rows where the zone diameter for tetracycine is less than 15 mm. 

```{r}

ecoli %>%
  select(`Location Name`, `Sample ID`, `Tetracyclin (30µg)`) %>%
  filter(`Tetracyclin (30µg)` < 15)
  
```

**Renaming columns**

Rename the columns so that they are simple, informative, and do not contain any special characters. 

```{r}
#Rename columns
colnames(ecoli_select) <- c("meatshop", "stratification", "location", "GPSx", "GPSy", "date_collection", "sample_type", "sample_collection", "sample_weight_Kg", "sample_source", "farm_category", "slaughter", "transportation", "transport_medium", "transport_other_meat", "sampleID", "FTLcode", "GEN", "CHL", "MEM", "CRO", "CIP",  "FEP", "NAL", "AMP", "TCY", "SXT")
```

In the above example the antibiotic names have been changed to their abbreviated form. Check the abbreviation that is used by the AMR package for streptomycin

```{r}
as.ab("streptomycin")
```

To view all the antibiotics listed in the antibiotics data set from the AMR package:

```{r, eval=FALSE}
view(antibiotics)
```

Alternatively to rename specific columns use the rename() function.

```{r}
ecoli %>% rename(meatshop = `Name of meat shop`,
                 location = `Location Name`,
                 sample_collection = `Date of sample collection`)
```

***Formatting the date***

Some of the dates look like they may be in an excel serial date format. There are methods in R that you can use to format the dates into the same format. 

```{r, eval = FALSE, results='hide', echo=FALSE}
ec_test <- ecoli_select %>%
  mutate(date_collection = as.character(date_collection),  # Convert to character
         date_collection = case_when(
           grepl("^[0-9]+$", date_collection) ~ as.character(as.Date(as.numeric(date_collection), origin = "1899-12-30")),  # Convert Excel serial numbers
           TRUE ~ as.character(dmy(date_collection))  # Convert DD-MM-YYYY or other formats
         )) %>%
  mutate(date_collection = ymd(date_collection))  # Ensure final format is YYYY-MM-DD



```

Re-read version 2 of the excel file, which has the correct format and then change the date column to date format. 

```{r}
ecoli <- read_excel("data/bh_AMR_Surveillance_datav2.xlsx", sheet = "E.coli")
#Remove columns starting with SIR, change column names and add a new column with species                    
ecoli_select <- ecoli %>% 
  select(!starts_with("SIR")) %>%
  setNames(c("meat_shop", "stratification", "location_name", "GPS_x", "GPS_y", 
             "date_collection", "sample_type", "sample_collection", "sample_weight_Kg", 
             "sample_source", "farm_category", "slaughter", "transportation", 
             "transport_medium", "transport_with_other_meat", "sample_ID", "FTL_code", 
             "GEN", "CHL", "MEM", "CRO", "CIP", "FEP", "NAL", "AMP", "TCY", "SXT"))  %>%
  mutate(species = "Escherichia coli") # add in a column called species

str(ecoli_select)

#Change to date format
library(lubridate)
ecoli_select$date_collection <- ymd(ecoli_select$date_collection)
```

Often dates will come through as class "character". In the example above they are in the POSIXIt data type which is also a date/time data type. However, by using the lubridate function ymd() it is converted to the date data type, which means the package lubridate can then then be used for date analyses. 

***Manipulating categorical values***

Check whether the categorical variable values are consistent for the meat_shop categorical variable using the table function. 

```{r}
table(ecoli_select$meat_shop, useNA = "ifany")

#Look for values with specific characteristics, e.g. check all fields use correct spelling of meat shop values
table(ecoli_select$meat_shop %in% c("AM MS", "DB MS", "GM MS"))
```

Use the sort and unique functions to check the meath_shop categorical variable values.

```{r}
sort(unique(ecoli_select$meat_shop))
```

The base R function gsub() and the str_replace functions from the stringr packages can be used to replace strings.

Use gsub to remove "."
```{r}

gsub("\\.", "", ecoli_select$meat_shop)
```

Use str_replace to remove the "." and replace "Bebak MS with BK MS" and assign to the object ecoli_select.

```{r}

ecoli_select <- ecoli_select %>%
  mutate(meat_shop = str_replace_all(meat_shop, "\\.", ""),  # Remove all dots
         meat_shop = str_replace(meat_shop, "Bebak MS", "BK MS"))

sort(unique(ecoli_select$meat_shop))
       
```

***Exercise***

Check whether any of the other categorical values need to be changed and change where appropriate. 

***Manipulating categorical values***

The farm_category column uses both a capital "C" and a lowercase "c" has been used for the word commercial. 

```{r}
sort(unique(ecoli_select$farm_category))
```

Here are some other ways that categorical values can be replaced. 

```{r}

#The replace function can be used for one replacement
mutate(ecoli_select, farm_category = replace(farm_category, farm_category == "commercial", "Commercial"))

#recode() can be used for multiple replacements
ecoli_select %>%
  mutate(farm_category = recode(farm_category, 
                                "Commercial" = "commercial", 
                                "Semi-commercial" = "semi-commercial"))

#Alternatively str_ functions can be used to change the case
mutate(ecoli_select, farm_category = str_to_lower(farm_category))
ecoli_select <- mutate(ecoli_select, farm_category = str_to_title(farm_category))
unique(ecoli_select$farm_category)
```

### Missing values

Check whether there are any missing values. These are labelled as NA (meaning not available) in R.

```{r na}
#Display rows that aren't complete cases
ecoli_select[!complete.cases(ecoli_select),]

#Display rows that aren't complete cases
campy[!complete.cases(campy),]

# Displays entire df where TRUE == NA, FALSE there is no NA
is.na(campy)

#Show rows where sample ID == NA
campy[is.na(campy$'Sample ID'), ]



#If false no values are na
any(is.na(campy$'Sample ID'))
#Will check to see all values meet this conditon
all(ecoli_select$TCY >= 6)


```

To remove all rows with missing values use the complete.cases function.

```{r}
```

To only remove rows where there are missing values in a specific column use the drop_na function

```{r}


#drop_na(maths)

```

Alternatively missing values can be removed when when applying a function. For example when calculating the mean.

```{r}

mean(ecoli_select$TCY, na.rm = TRUE)
```

### Data distribution

Check whether the distribution of disk diffusion values looks ok. 

```{r}
#Checking what the phenotype looks like, that there were no strange values.
hist(ecoli_select$GEN)
hist(ecoli_select$CHL)
hist(ecoli_select$MEM)
hist(ecoli_select$CRO)
hist(ecoli_select$CIP)
hist(ecoli_select$FEP)
hist(ecoli_select$NAL)
hist(ecoli_select$AMP)
hist(ecoli_select$TCY)
hist(ecoli_select$SXT)
```

## Day 2: Using the AMR R package

### Generating an antibiogram

First the disk diffusion data is converted to "disk" data type and a new column  is generated using the mutate_if() function for the SIR data. In the example below the disk diffusion values are converted to S, I or R based on the latest CLSI guidelines. You can change the AMR guideline using the guideline argument e.g. guideline == "CLSI 2023".

```{r}
#Convert to "disk" data type
ecoli2 <- ecoli_select %>%
  mutate(across(GEN:SXT, as.disk))
str(ecoli2)

#To convert disk diffusion values to SIR
ecoli3 <- ecoli2 %>% mutate_if(is.disk, as.sir, guideline = "CLSI")
str(ecoli3)

#To keep disk diffusion columns and columns with SIR values
ecoli3 <- ecoli2 %>% mutate(across(GEN:SXT, ~ .x, .names = "{.col}_disk")) %>%
  mutate(across(GEN:SXT, ~ as.sir(.x, guideline = "CLSI")))



str(ecoli3)

  
            
```

You can define your own breakpoints:

```{r}
#generating an example dataframe
dat <- data.frame(
  patient_id = c("J3", "J3","J3","J3"),
  date = c("2018-11-21", "2018-04-03", "2018-09-19", "2018-12-10"),
  isolate = c(1,2,3,4),
  microorganism = c("Escherichia coli", "Escherichia coli", "Escherichia coli", "Escherichia coli"),
  CTX = c(27.2, 18.1, 34.0, 19.2),
  TCY = c(6.6, 7.2, 19.3, 17.2),
  STR = c(6.6, 12.5, 7.2, 17.2)
    )

#To define my own breakpoints
dat <- dat %>%
  mutate(across(CTX:STR, as.disk))%>% 
  mutate(STR = case_when(
    STR >= 15 ~ "S",  # Replace with your own breakpoints
    STR < 12 ~ "R",
    TRUE ~ "I"       # Intermediate
  )) %>%
  mutate_if(is.disk, as.sir, guideline = "CLSI")
```

To specify that you want to use the veterinary breakpoints (rather than human).

```{r}
ecoli2 %>% mutate_if(is.disk, as.sir, guideline = "CLSI", breakpoint_type = "animal")

```

Next generate an antibiogram:

```{r}

ant <- antibiogram(ecoli3,
            antibiotics = c("GEN", "CHL", "MEM", "CRO", "CIP", 
                           "FEP", "NAL", "AMP", "TCY", "SXT"), 
            ab_transform = "name",
            digits = 1)  # Show one decimal place

ant
```

Make a basic plot of the antibiograms using the autoplot() function.


```{r}

autoplot(ant)
```

***Exercise***

* Read in the Enterococci and Salmonella excel sheets and assign them to "enterococci" and "salmonella".
* Remove the SIR columns
* Change column names 
* Add a column called species with the appropriate species name (e.g. Enterococcus sp. Salmonella sp.)
* Check the data for multiple types of categorical values, missing values, outliers etc...
* Change the date format


```{r, results='hide', echo = FALSE}
enterococci <- read_excel("data/bh_AMR_Surveillance_datav2.xlsx", sheet = "Enterococci")
#Remove columns starting with SIR, change column names and add a new column with species                    
enterococci_select <- enterococci%>% 
  select(!starts_with("SIR")) %>%
  setNames(c("meat_shop", "stratification", "location_name", "GPS_x", "GPS_y", 
             "date_collection", "sample_type", "sample_collection", "sample_weight_Kg", 
             "sample_source", "farm_category", "slaughter", "transportation", 
             "transport_medium", "transport_with_other_meat", "sample_ID", "FTL_code", 
             "CHL", "AMP", "TCY", "ERY", "TGC", "QDA", "VAN", "LNZ")) %>%
  mutate(meat_shop = str_replace_all(meat_shop, "\\.", ""),  # Remove all dots
         meat_shop = str_replace(meat_shop, "Bebak MS", "BK MS"),
         farm_category = str_to_title(farm_category)) %>%
  mutate(species = "Enterococcus sp.")

salmonella <- read_excel("data/bh_AMR_Surveillance_datav2.xlsx", sheet = "Salmonella")
#Remove columns starting with SIR, change column names and add a new column with species                    
salmonella_select <- salmonella%>% 
  select(!starts_with("SIR"), -c(1, 20, 39:40)) %>%
  setNames(c("meat_shop", "stratification", "location_name", "GPS_x", "GPS_y", 
             "date_collection", "sample_type", "sample_collection", "sample_weight_Kg", 
             "sample_source", "farm_category", "slaughter", "transportation", 
             "transport_medium", "transport_with_other_meat", "sample_ID", "FTL_code", "GEN",
             "CHL", "MEM", "CRO", "CIP", "NAL", "AMP", "TCY", "SXT", "ETP")) %>%
  mutate(meat_shop = str_replace_all(meat_shop, "\\.", ""),  # Remove all dots
         meat_shop = str_replace(meat_shop, "Bebak MS", "BK MS"),
         farm_category = str_to_title(farm_category)) %>%
  mutate(species = "Salmonella sp.")

enterococci_select$date_collection <- ymd(enterococci_select$date_collection)
salmonella_select$date_collection <- ymd(salmonella_select$date_collection)
```

Bind the ecoli, enteroccoci and salmonella data frames together.

```{r}

df <- bind_rows(ecoli_select, salmonella_select, enterococci_select) %>%
  select(species, 1:34)
```

***Exercise***

1. Generate SIR columns for the new df.

2. Generate the following antibiograms:

    - For the antibiotics CHL, AMP and TCY

    - For the species *E. coli*

    - For the groups fridge and display table  (from the variable sample_collection) and antibiotics "CHL", "AMP", "TCY" and E. coli

3. Make some basic plots for each of the antibiograms


***Exercise 1***

```{r, results = FALSE}

df2 <- df %>%
  mutate(across(GEN:LNZ, as.disk))


#To keep disk diffusion columns and add new columns with SIR
df3 <- df2 %>% mutate(across(GEN:VAN, ~ .x, .names = "{.col}_disk")) %>%
  mutate(across(GEN:VAN, ~ as.sir(.x, guideline = "CLSI")))
```

***Exercise 2***

```{r}
ant1 <- antibiogram(df3,
            antibiotics = c("CHL", "AMP", "TCY"), 
            ab_transform = "name",
            digits = 1)  # Show one decimal place

ant1

```


```{r}

ant2 <- df3 %>% 
  filter(species == "Escherichia coli") %>%
  antibiogram(ab_transform = "name",
            digits = 1)  # Show one decimal place

ant2

```

```{r}

#Using the antibiogram function from the AMR package

ant3 <- df3 %>% 
  filter(species == "Escherichia coli") %>%
  antibiogram(antibiotics = c("CHL", "AMP", "TCY"), syndromic_group = "sample_collection", ab_transform = "name",
            digits = 1,
             )

ant3
```

***Exercise 3***

Make some basic plots of the antibiograms using the autoplot().

```{r}
autoplot(ant1)
autoplot(ant2)
autoplot(ant3)
```

Use dplyr and ggplot to generate antibiograms and a plot 

```{r}
#Using  the AMR and dplyr packages

df3 %>%
  filter(species == "Escherichia coli") %>%
  select(sample_collection, CHL) %>%
  group_by(sample_collection) %>%
  count_df(translate = FALSE)

#Plotting the antibiogram
df3 %>%
  filter(species == "Escherichia coli") %>%
  select(sample_collection, CHL) %>%
  group_by(sample_collection) %>%
  ggplot_sir(x = "sample_collection")

```


## Confidence Intervals 

Use the AMR package function sir_confidence_interval() to calculate confidence intervals. This function uses the Clopper-Pearson method (using the binom.test())

```{r CI}
sir_confidence_interval(ecoli3$CHL)


df_summary <- ecoli3 %>%
  mutate(across(c(CHL, AMP, TCY), as.factor)) %>%  # Ensure that columns are factors
  summarise(
    CHL_percent_susceptible = mean(CHL == "S", na.rm = TRUE) * 100,
    AMP_percent_susceptible = mean(AMP == "S", na.rm = TRUE) * 100,
    TCY_percent_susceptible = mean(TCY == "S", na.rm = TRUE) * 100,
    
    # Calculate CI directly in the summarise function
    CHL_CI_lower = sir_confidence_interval(CHL)[1],
    CHL_CI_upper = sir_confidence_interval(CHL)[2],
    AMP_CI_lower = sir_confidence_interval(AMP)[1],
    AMP_CI_upper = sir_confidence_interval(AMP)[2],
    TCY_CI_lower = sir_confidence_interval(TCY)[1],
    TCY_CI_upper = sir_confidence_interval(TCY)[2]
  )
  
  
```

## Day 3 - Using the AMR R Package


# First isolates

Material for the following tutorial was taken from  https://msberends.github.io/AMR/articles/AMR.html#first-isolates. 

When there are multiple isolates from the same sample the function first_isolate() can be used to correct for duplicate isolates. There are four different methods for that can be used for selecting the isolate(s) as described by [Hindler et al. (2007)] (https://academic.oup.com/cid/article/44/6/867/364325). The default method is phenotype-based. The other three options are "episode-based", "patient-based" and "isolate-based". 

```{r}
our_data <- example_isolates %>% 
  select(patient, ward, date, mo, AMX, AMC, CXM) %>%
  filter(complete.cases(.))

str(our_data)  

our_data %>%
  mutate(first = first_isolate())

our_data %>%
  mutate(first = first_isolate(method = "phenotype-based"))
```

Look at the different arguments available for the first_isolate function using ?first_isolate and try some of them out

```{r}

our_data %>%
  mutate(first = first_isolate(method = "phenotype-based", type = "points", points_threshold = 1))

our_data %>%
  mutate(first = first_isolate(method = "episode-based", episode_days = 7)) # 7 day interval from initial isolate

our_data %>%
  mutate(first_isolate(type = "keyantimicrobials", points_threshold = 1, col_keyantimicrobials = "AMX"))


```

Once you have decided which method you are going to use to determine the "first isolates", filter the dataframe. 

```{r}

our_data1 <- our_data %>%
  mutate(first = first_isolate(method = "phenotype-based", type = "points", points_threshold = 1)) %>%
  filter_first_isolate()

our_data %>%
  count(mo_name(mo), sort = TRUE)

our_data1 %>%
  count(mo_name(mo), sort = TRUE)

our_data1 %>%
  filter(all(betalactams() == "R"))
```

# MIC frequency distribution 

Material for the following tutorial was taken from https://msberends.github.io/AMR/articles/AMR.html#interpreting-mic-and-disk-diffusion-values

Minimum inhibitory concentrations can also be converted into SIR using the as.sir() function. In the following example the MIC values are randomly generated and these values are then converted into SIR for *Klebsiella pneumoniae* using the EUCAST 2023 guidelines.

```{r}
set.seed(123)

#MIC values randomly generated
mic_values <- random_mic(100)



#MIC values converted to SIR
sir_values <- as.sir(mic_values, mo = "K. pneumoniae", ab = "cipro", guideline = "EUCAST 2023")

#Create a tibble
my_data <- tibble(MIC = mic_values, SIR = sir_values)
my_data

#autoplot the mic values
autoplot(mic_values)
autoplot(mic_values, mo = "K. pneumoniae", ab = "cipro", guideline = "EUCAST 2023")
```

The AMR R package cannot be used to generate an MIC frequency table so here dyply has been used to generate this table. 

```{r}
mic_values <- random_mic(90, mo = "Escherichia coli")

antibiotic <- rep(c("Ampicillin","Gentamicin", "Tetracycline"), each = 30)
animal <- rep(c("Cattle", "Pig", "Chicken"), times = 30)
dat <- tibble(MIC = mic_values, Antibiotic= antibiotic, Animal = animal)

# Define the MIC categories
mic_breaks <- c(0, 0.25, 0.5, 1, 2, 4, 8, 16, 32, 64, Inf)
mic_labels <- c("0.25", "0.5", "1", "2", "4", "8", "16", "32", "64", "128")

# Create the frequency table
mic_table <- my_data %>%
  mutate(MIC = as.numeric(MIC)) %>%
  mutate(MIC_category = cut(MIC, breaks = mic_breaks, labels = mic_labels, right = FALSE)) %>%
  group_by(Antibiotic, Animal) %>%
  count(MIC_category) %>%
  pivot_wider(names_from = MIC_category, values_from = n, values_fill = 0)

#write.table(mic_table, file = "output/mic.txt", row.names = FALSE)

my_data %>%
  group_by(Antibiotic, Animal) %>%
  reframe(
    MIC_min = min(MIC),
    MIC_max = max(MIC),
    MIC50 = median(MIC),
  )

```

# Determining multi-drug resistance

Material for the following tutorial was taken from https://msberends.github.io/AMR/articles/MDR.html

The number of MDR isolates can be determined using the mdro() function. Use the example_isolates  

```{r}
x <- mdro(example_isolates, guideline = "EUCAST")
table(x)

example_isolates %>%
  mdro() %>%
  freq()
```
- Determining MDR and barplot resistance to n antibiotic classes

```{r}
```
- Scatterplot correlations (Use Natalia's data)

```{r}
```
- Principal Component analysis 

```{r}
```

## Day 4 - Plotting

The main structure for generating a ggplot is:
ggplot(data = <dataframe> + geom<name>(mapping = aes(x = <x_variable>, y = <y_variable>, color = <variable_for_color>)))

See [the basics of ggplot](https://d3c33hcgiwev3.cloudfront.net/fsV6V9GESOqUefnwRfLe0w_2eaf49b2cfcf450db2f2bb95681f55f1_03_01grammarofgraphics.html?Expires=1741046400&Signature=CP49Mmw63hpCBlR5IBPO~We~0Djsy5Qox2zfzNyAISHCWkq6Amnqz6o8-1mcao8FBsA0hOvT4iKd7VARcOBVj5aamI6GMNxPgb2MDld2udjVFGQZu-4RNp0kKCEg693bmJOf6ryogLAXgKPEUT9-dVZ852EnOk-0iZU89PVvt7w_&Key-Pair-Id=APKAJLTNE6QMUY6HBC5A) from the arranging and visualising coursera course. 

***Some basic examples of plots***

```{r ggplot}
ggplot(data = ecoli3) +
  geom_point(mapping = aes(x = date_collection, y = CHL_disk, color = farm_category))

ggplot(data = ecoli3) +
  geom_line(mapping = aes(x = date_collection, y = CHL_disk, color = farm_category))

ggplot(data = ecoli3) + 
  geom_histogram(mapping = aes(x = CHL_disk), 
                 binwidth = 2)

df4 <- df3 %>%
  filter(species == "Escherichia coli") %>%
  select(sample_collection, CHL, CHL_disk)

#Barplot with counts
ggplot(data = df4) + 
  geom_bar(mapping = aes(x = sample_collection, fill = CHL))

ggplot(data = df4) + 
  geom_bar(mapping = aes(x = sample_collection, fill = CHL)) +
  coord_flip()

#Barplot with proportion
ggplot(data = df4) + 
  geom_bar(mapping = aes(x = sample_collection, fill = CHL), position = "fill")

ggplot(data = df4) + 
    geom_boxplot(mapping = aes(x = CHL_disk, y = sample_collection))
```


```{r}
ggplot(ecoli3, aes(x = GEN)) +
  geom_bar(fill = "steelblue", color = "black") +
  labs(
    title = "Frequency of Antimicrobial Interpretations (CTX)",
    x = "GEN Interpretation (S, I, R)",
    y = "Frequency"
  ) +
  theme_minimal()
```

```{r}
ggplot(ecoli3,
       aes(x = sample_collection, y = GEN_disk, colour = GEN)) +
  geom_jitter(width = 0.2, size = 2) +
  geom_boxplot(fill = NA, colour = "grey40") +
  #scale_y_mic() +
  #scale_colour_sir() +
  labs(title = "MIC Distribution and SIR Interpretation",
       x = "Sample Groups",
       y = "disk diffusion zone (mm)")

# add a group
my_data$group <- rep(c("A", "B", "C", "D"), each = 25) 

ggplot(my_data,
       aes(x = group, y = MIC, colour = SIR)) +
  geom_jitter(width = 0.2, size = 2) +
  geom_boxplot(fill = NA, colour = "grey40") +
  scale_y_mic() +
  scale_colour_sir() +
  labs(title = "MIC Distribution and SIR Interpretation",
       x = "Sample Groups",
       y = "MIC (mg/L)")

```

## Plots for publications

```{r}

ecoli_res <- ecoli3 %>%
  filter(species == "Escherichia coli") %>%
  mutate(
    month = floor_date(date_collection, "month")  # Convert to first day of month
  ) %>%
  select(month, sample_source, location_name, sample_collection, AMP, TCY)

ecoli_long <- ecoli_res %>%
  pivot_longer(cols = AMP:TCY, names_to = "antibiotic", values_to = "resistance") %>%
  mutate(resistance = ifelse(as.numeric(resistance) == 3, 1, 0)) %>%
  unite(source_location, sample_source, location_name, sep = "_", remove = FALSE)

res_summary <- ecoli_long %>%
  group_by(month, antibiotic) %>%
  summarise(percent_resistant = mean(resistance) * 100)

ggplot(res_summary, aes(x = month, y = percent_resistant, color = antibiotic)) +
  geom_line() +
  geom_point() +
  scale_x_date(date_labels = "%b-%Y", date_breaks = "1 month") +
  labs(
    title = "Percentage of Resistant Isolates Over Time",
    x = "Time (Month)",
    y = "Percentage Resistant",
    color = "Antibiotic") +
    theme_minimal() +
  theme(axis.text.x = element_text(angle = 45))

library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)
res_location <- ecoli_long %>%
  filter(antibiotic == "AMP") %>%
  group_by(sample_source, antibiotic) %>%
  summarise(percent_resistant = mean(resistance) * 100)

#Using a detailed map with regions from the rnaturalearthhires package 
bhutan_map <- ne_states(country = "Bhutan", returnclass = "sf")

#Merging the map data with the perc_resistance data, note there must be matching columns.
map_data <- left_join(bhutan_map, res_location, by = c("name_sv" = "sample_source"))


ggplot(data = map_data) +
geom_sf(aes(fill = percent_resistant)) +  # Fill regions based on resistance
geom_sf_text(aes(label = ifelse(is.na(percent_resistant), name_sv,
paste0(name_sv, "\n", round(percent_resistant, 1), "%")
)),
color = "black", size = 3) +  # Colors region names black size 3
scale_fill_gradient(low = "lightblue", high = "darkblue", na.value = "white",
name = "Resistance Rate (%)") +
theme_minimal() +
theme(axis.text = element_blank(),
axis.ticks = element_blank(),
panel.grid = element_blank(),
axis.title = element_blank()
)

res_source <- ecoli_long %>%
  group_by(source_location, antibiotic) %>%
  summarise(percent_resistant = mean(resistance) * 100)

df_summary <- ecoli_long %>%
group_by(antibiotic, source_location, sample_collection) %>%
summarise(mean_resistance = mean(resistance) * 100, .groups = "drop")
df_summary

ggplot(df_summary, aes(x = antibiotic, y = mean_resistance, fill = antibiotic)) +
geom_boxplot(outlier.shape = NA, alpha = 0.5) +  # Boxplot (removing default outliers)
geom_jitter(aes(color = antibiotic), width = 0.2, size = 2, alpha = 0.7) +  # Individual data points
facet_wrap(~ sample_collection, scales = "free") +  # Separate by sample_collection
scale_fill_brewer(palette = "Set3") +
scale_color_brewer(palette = "Set3") +
labs(title = "Antibiotic Resistance by Source Location",
x = "Collection Point",
y = "Mean Resistance (%)") +
theme_minimal() +
theme(legend.position = "top",
axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(df_summary, aes(x = antibiotic, y = mean_resistance, fill = antibiotic)) + #Define the aesthetic mappings for x, y and fill
    geom_boxplot(width = 0.2) +  #Create the box plot and specify width of boxes
    geom_jitter(aes(color = antibiotic), size = 3) +  # Adds individual data points which are jittered
    facet_wrap(~ sample_collection, scales = "free") +  # Separates plots into two facets by sample_collection
    scale_fill_brewer(palette = "Set3") +  #Colour for box plots
    scale_color_brewer(palette = "Set3") +  #Colour for points
    labs(y = "Occurrence of Resistance (%)") + #Y axis label
    theme_minimal() +
    theme(legend.position = "top", #position legend at the top
          axis.text.x = element_blank(),  # Remove x-axis text)
          axis.title.x = element_blank())  # Remove x-axis label
              

```

```{r}
data <- tibble(
  Source = c("Open community", "Surface freshwater", "Wild birds", "Chicken meat", "Bovine meat",
             "Sheep and goat meat", "Pork", "Turkey meat", "Seafood", "Raw vegetables", "Chickens",
             "Cattle", "Sheep and goats", "Pigs", "Dogs", "Cats", "Horses", "Clinical patients",
             "Returning travellers", "Farmers"),
  Prevalence = c(30, 10, 15, 50, 40, 35, 20, 15, 45, 55, 25, 10, 5, 12, 8, 6, 4, 15, 10, 20),
  HumanExposure = c(50, 5, 8, 40, 35, 30, 18, 12, 50, 60, 22, 8, 3, 10, 6, 5, 3, 12, 8, 15)
)

# Convert prevalence to negative values for mirroring
data <- data %>%
  mutate(Prevalence = -Prevalence)

# Create the mirrored bar chart
ggplot(data) +
  geom_col(aes(x = Prevalence, y = reorder(Source, Prevalence)), fill = "blue", alpha = 0.5) +  # Left side
  geom_col(aes(x = HumanExposure, y = reorder(Source, Prevalence)), fill = "blue", alpha = 0.8) +  # Right side
  geom_vline(xintercept = 0, linetype = "dashed") +  # Center line
  labs(x = "ESBL-EC & pAmpC-EC prevalence (%)       |       Human exposure (%)",
       y = "",
       title = "Prevalence of ESBL-EC and pAmpC-EC in different sources",
       caption = "Source: Sample Data") +
  theme_minimal(base_size = 14)
```

- Upset plot
- Holly's code here
- Sankey diagram Figure 4 Mughini-Gras

## Day 5 - Local and Health Chickens Comparison

- See Figure 2 Mughini-Gras

Links to the AMR R package
https://cran.r-project.org/web/packages/AMR/AMR.pdf

Links to other useful tutorials

For dates and times see https://r4ds.had.co.nz/dates-and-times.html 

References

Berends et al. AMR: An R Package for Working with Antimicrobial Resistance Data doi: 10.18637/jss.v104.i03